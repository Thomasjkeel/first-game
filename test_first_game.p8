pico-8 cartridge // http://www.pico-8.com
version 16
__lua__

-- globals --
-- variables --
local player
local mandarins
local coins
local score
local mandarin_score

function _init()
 score=0
 mandarin_score=0
 player = {
  x=64,
  y=64,
  color=9,
  name="thomas",
  width=6,
  height=8,
  radius=4,
  move_speed=1,
  mandarin_alligned=false,
  draw=function(self)
   spr(1, self.x, self.y)
   -- circ(self.x,self.y,self.radius,12)
   local x,y,w,h=self.x,self.y,self.width,self.height
   -- bounding box
   rect(x,y,x+w,y+h, 12)
   -- bottom hitbox
   rectfill(x+2,y+(h/2),x+w-2,y+h,8)
   -- top hitbox
   rectfill(x+2,y+(h/2),x+w-2,y,12)
   -- side hitboxes
   rectfill(x,y+2,x+w/2,y+h-2, 11)
   rectfill(x+w/2,y+2,x+w,y+h-2, 10)


  end,
  update=function(self)
   if btn(0) then
    self.x-=self.move_speed
   end
   if btn(1) then
    self.x+=self.move_speed
   end
   if btn(2) then
    self.y-=self.move_speed
   end
   if btn(3) then
    self.y+=self.move_speed
   end
  end,
   -- check hit detection
  check_collision=function(self,other)
    -- collect the other (coin or mandarin)
   -- if not other.iscollected and circ_overlapping(self.x,self.y,self.radius,other.x,other.y,other.radius) then
   if not other.iscollected and rect_overlapping(self.x,self.y,self.x+self.width,self.y+self.height,other.x,other.y,other.x+other.width,other.y+other.height) then
    other.iscollected=true
    if other.name == "coin" then
     sfx(0)
     score+=1
    else
     sfx(2)
     mandarin_score+=1
    end
   end
 end,

 check_for_block_collision=function(self, block)
  if bounding_boxes_overlapping(self,block) then
   local top_hitbox={
    x+2,y+(h/2),x+w-2,y+h
   }
   -- top hitbox
   local bottom_hitbox={
    x+2,y+(h/2),x+w-2,y
   }
   -- side hitboxes
   local left_hitbox={
    x,y+2,x+w/2,y+h-2
   }
   local right_hitbox={
    x+w/2,y+2,x+w,y+h-2
   }
  end

 end
 }
 -- coin
 coins={
  make_coin(),
  make_coin(),
  make_coin()
 }
 -- mandarins
 mandarins={
  make_mandarin(),
  make_mandarin()
 }
 -- blocks
 blocks={
  make_block(50,50),
  make_block(50,40)
 }

end

function _update()
 player:update()
 for coin in all(coins) do
  coin:update()
  player:check_collision(coin)
 end
 for mandarin in all(mandarins) do
  mandarin:update()
  player:check_collision(mandarin)
 end
 for block in all(blocks) do
  block:update()
  player:check_for_block_collision(block)
 end
end

function _draw()
 cls(13)
 print("score: " .. score, 5, 5, 7)
 print("mandarins: " .. mandarin_score, 75, 5, 7)
 local block
 for block in all(blocks) do
  block:draw()
 end
 player:draw()
 local coin
 for coin in all(coins) do
  coin:draw()
 end
 local mandarin
 for mandarin in all(mandarins) do
  mandarin:draw()
 end

end


function make_coin()
 local coin={
  x=flr(rnd(40))+64,
  y=flr(rnd(40))+64,
  width=6,
  height=7,
  radius=3,
  name="coin",
  iscollected=false,
  update=function(self)
  end,
  draw=function(self)
   if not self.iscollected then
    spr(3, self.x, self.y)
    -- circ(self.x,self.y,self.radius,12)
    rect(self.x,self.y,self.x+self.width,self.y+self.height,12)
   end
  end
 }
 return coin
end

function make_mandarin()
 local mandarin={
  x=flr(rnd(40))+5,
  y=flr(rnd(40))+10,
  width=6,
  height=6,
  radius=3,
  name="mandarin",
  iscollected=false,
  update=function(self)
  end,
  draw=function(self)
   if not self.iscollected then
    spr(4, self.x, self.y)
    -- circ(self.x,self.y,self.radius,12)
    rect(self.x,self.y,self.x+self.width,self.y+self.height,12)
   end
  end
 }
 return mandarin
end

function make_block(x,y)
 block={
  x=x,
  y=y,
  width=8,
  height=8,
  update=function(self)
  end,
  draw=function(self)
   spr(2,self.x,self.y)
   rect(self.x,self.y,self.x+self.width,self.y+self.height, 12)
  end
 }
 return block
end


function lines_overlapping(min1,max1,min2,max2)
 return max1>min2 and max2>min1
end

function rect_overlapping(left1,top1,right1,bottom1,left2,top2,right2,bottom2)
 return lines_overlapping(left1,right1,left2,right2) and lines_overlapping(top1,bottom1,top2,bottom2)
end

function circ_overlapping(x1,y1,r1,x2,y2,r2)
 local dx=mid(-100,x2-x1,100)
 local dy=mid(-100,y2-y1,100)
 return dx*dx+dy*dy<(r1+r2)*(r1+r2)
end

function bounding_boxes_overlapping(obj1,obj2)
 return rect_overlapping(obj1.x,obj1.y,obj1.x+obj1.width,obj1.y+obj1.height,obj2.x,obj2.y,obj2.x+obj2.width,obj2.y+obj2.height)
end

__gfx__
00000000099999001166661100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000009ccc90066611666009aa000000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070009ccc9006155551609aaaa00004990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000999999906551555609aaaa00049999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000999999906555155609aaaa00049999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700099099006155551609aaaa00004990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000009990999066611666009aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000999099901166661100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000021412000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000020002020202020202001400020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000002020202020200000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000040000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0002000000001400020004000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000400002d0102f02033030350503906039070390203902001000290002c0000f1000c100141001a1002010025100291003310036100151001610000000000000000000000000000000000000000000000000000
000200000755007550075500755007550105500c550145500e5501355016550035000f500045000f5000450004500000000000000000000000000000000000000000000000000000000000000000000000000000
000500001e7501a7501e750287502f750317500b700127000b7000f700117001c700300002f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
